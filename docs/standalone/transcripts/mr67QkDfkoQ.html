<!DOCTYPE html>

<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="//google.com">
  <meta name="description" content="web.dev LIVE video transcript">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>mr67QkDfkoQ</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<iframe id="youtube" src="https://www.youtube.com/embed/mr67QkDfkoQ?enablejsapi=1"></iframe>

<div id="container">

<div id="options">
  <div id="google-translate"></div>
  <div>
    <input type="checkbox" id="videoSticky" checked>
    <label for="videoSticky">Video position sticky</label>
  </div>
  <div>
    <input type="checkbox" id="captionScroll" checked>
    <label for="captionScroll">Keep current caption visible</label>
  </div>
</div>

<section>
<p><span data-start="15.3" data-end="16.97">Hello, I'm Jake.</span> <span data-start="17.68" data-end="18.68">I'm Jason.</span> <span data-start="19.6" data-end="21.64">Earlier in this conference, we released â€” Is this a</span> <span data-start="21.64" data-end="24.35">conference? Actually, is this a conference or it like an</span> <span data-start="24.6" data-end="26.69">event? I don't know. Let's call it a conference.</span> <span data-start="27.1" data-end="28.65">Earlier in this conference. We released Tooling.Report.</span> <span data-start="29.9" data-end="32.78">This is a website. It looks at all the different JavaScript</span> <span data-start="33.11" data-end="34.28">bundling build tools.</span> </p>
<p><span data-start="34.57" data-end="36.61">Shows the things they're good at and things they're not so</span> <span data-start="36.61" data-end="39.53">good at. But in this session, we are going to write our own</span> <span data-start="39.66" data-end="40.66">plugin.</span> <span data-start="40.66" data-end="43.33">Right. So cruising around the web, we see lots of sites</span> <span data-start="43.33" data-end="44.45">with performance issues.</span> <span data-start="44.79" data-end="46.66">And a lot of times these can be solved with something</span> <span data-start="46.66" data-end="49.42">simple, like a preload tag for a web font</span> <span data-start="49.92" data-end="51.88">or some selective code splitting.</span> <span data-start="52.92" data-end="54.67">But the thing is, when these are controlled by a build</span> <span data-start="54.67" data-end="58.13">system or even, like, deep in layers within a build system,</span> <span data-start="58.47" data-end="60.09">making those changes can be really tricky.</span> </p>
<p><span data-start="60.64" data-end="64.06">So supposedly simple changes can start to seem impossible.</span> <span data-start="64.35" data-end="67.73">Yes. But once you are familiar with writing build plugins,</span> <span data-start="68.19" data-end="69.98">sure, that means you can write build plugins.</span> <span data-start="70.02" data-end="72.69">But it also gives you like insight into how the build tool</span> <span data-start="72.69" data-end="75.44">works. It makes it easier to debug things when they go</span> <span data-start="75.44" data-end="78.24">wrong. And of course, it means that you can go and help</span> <span data-start="78.24" data-end="80.66">with community plugins as well and do PRs and add features</span> <span data-start="80.66" data-end="81.87">and fix bugs, that kind of thing.</span> </p>
<p><span data-start="82.33" data-end="84.99">Definitely. So we're going to create the same plugin for</span> <span data-start="85.24" data-end="86.25">Rollup and then for webpack.</span> <span data-start="87.16" data-end="89.54">Just because those are the two most popular and growing</span> <span data-start="89.54" data-end="90.75">build tools that we've seen.</span> </p>
<p><span data-start="91.13" data-end="92.71">So what are we actually building?</span> <span data-start="93.96" data-end="96.67">We are going to build a service worker plugin.</span> <span data-start="97.09" data-end="98.88">Of course, we're going to build a service worker plugin.</span> <span data-start="100.13" data-end="103.14">So the actual subject matter of a service worker</span> <span data-start="103.35" data-end="104.93">plugin itself doesn't matter all too much.</span> <span data-start="105.93" data-end="108.89">We picked this because it touches on a couple</span> <span data-start="108.89" data-end="110.98">different parts of the build process.</span> <span data-start="111.23" data-end="113.27">So it's one of those things that seems simple on the</span> <span data-start="113.27" data-end="115.61">surface. But there's actually quite a bit of complexity</span> <span data-start="115.61" data-end="116.61">when you dig in.</span> </p>
<p><span data-start="116.98" data-end="118.03">Right. So here's the app.</span> <span data-start="118.28" data-end="121.28">Now we're going to go through the whole app, but it has</span> <span data-start="121.61" data-end="123.49">JavaScript, CSS, images, and HTML, all</span> <span data-start="124.74" data-end="126.33">of which are part of the build process.</span> <span data-start="127.87" data-end="130.83">Right. So the bit that we care about for this session is</span> <span data-start="130.83" data-end="133.17">specifically the registering of a service worker.</span> <span data-start="134.42" data-end="137.05">So the URL of a service worker should never change.</span> </p>
<p><span data-start="137.46" data-end="139.76">And that's because we need to be able to go and check for</span> <span data-start="139.76" data-end="142.93">updates at that URL, but it'd be really nice if we didn't</span> <span data-start="142.93" data-end="144.64">have to duplicate that URL here and</span> <span data-start="146.01" data-end="148.81">in our build configuration and on disk.</span> <span data-start="149.64" data-end="151.73">And instead that was just filled in by the build system.</span> <span data-start="153.19" data-end="154.98">So here's a code for the service worker.</span> </p>
<p><span data-start="155.77" data-end="157.57">We're not going to go over all about how service workers</span> <span data-start="157.78" data-end="160.78">work. There are articles for that, but here are the things</span> <span data-start="160.78" data-end="162.15">we need for this build system.</span> <span data-start="162.66" data-end="164.03">We need a list of URLs to cache.</span> <span data-start="164.62" data-end="167.28">So this should be our HTML, CSS, JavaScript, and images.</span> <span data-start="167.62" data-end="169.79">These are the things that a native app would ship as part</span> <span data-start="169.79" data-end="172.96">of its bundle. Now, we can't just hard</span> <span data-start="172.96" data-end="175.58">code these because the build system is going to change the</span> <span data-start="175.58" data-end="176.71">file name, it's going to make them cachable.</span> <span data-start="178.46" data-end="180.3">It might also code split as well, which is going to</span> <span data-start="180.3" data-end="182.76">generate a whole new JavaScript files that we didn't know</span> <span data-start="182.76" data-end="185.72">about in advance. So because we can't predict it, we</span> <span data-start="185.72" data-end="187.26">need to build tool to fill it all in.</span> </p>
<p><span data-start="188.18" data-end="191.18">Right. So we also need a version for</span> <span data-start="191.18" data-end="194.02">the cache. And this is because when we're installing a new</span> <span data-start="194.1" data-end="196.94">version of the app, we want to use a new cache.</span> <span data-start="196.98" data-end="199.94">That way, we don't potentially disrupt any current version</span> <span data-start="199.94" data-end="202.74">of the application that's in use, maybe in another tab.</span> <span data-start="203.36" data-end="206.12">And so because of that, we need the version to be unique</span> <span data-start="206.37" data-end="208.7">for each given set of assets.</span> </p>
<p><span data-start="209.49" data-end="211.7">Yes. And if we don't change the assets, the version number</span> <span data-start="211.7" data-end="214.37">should stay the same. But if we, say like, update the</span> <span data-start="214.75" data-end="216.67">HTML, the version number needs to change.</span> <span data-start="217.29" data-end="218.29">Easy, right?</span> </p>
<p><span data-start="218.63" data-end="221.76">Right. So the challenge is that we</span> <span data-start="222.21" data-end="224.3">really want the service worker to be part of the main</span> <span data-start="224.3" data-end="227.34">build. We want it to potentially take part in code</span> <span data-start="227.34" data-end="230.35">splitting. We want to minify it just like we would our</span> <span data-start="230.35" data-end="231.64">application JavaScript.</span> <span data-start="231.77" data-end="234.6">And also apply any other plugins and optimizations that we</span> <span data-start="234.6" data-end="235.69">have to that code.</span> <span data-start="236.56" data-end="239.32">The thing is, it also needs to know about the final build</span> <span data-start="239.36" data-end="242.15">result. And that is only available once the build</span> <span data-start="242.44" data-end="243.44">is finished.</span> <span data-start="243.86" data-end="246.57">OK. Here is how I would do this in Rollup.</span> <span data-start="247.95" data-end="249.07">We need to get that service worker URL.</span> <span data-start="249.49" data-end="251.24">So I'm going to import it.</span> <span data-start="251.54" data-end="254.04">Now, note it looks a little bit magic.</span> <span data-start="254.04" data-end="256.17">It's got this sort of fake URL scheme.</span> </p>
<p><span data-start="257.71" data-end="258.96">This divides people.</span> <span data-start="259.5" data-end="262.55">I really like this because I want this to look weird</span> <span data-start="263.01" data-end="265.38">if it's a special part of the build, because it means you</span> <span data-start="265.38" data-end="266.55">look at this code you like, huh?</span> <span data-start="266.97" data-end="268.39">That's odd. Yes, it is odd.</span> <span data-start="268.68" data-end="270.6">The build tool is going to do something special here.</span> <span data-start="271.31" data-end="273.6">It also means like if the build tool doesn't do something</span> <span data-start="273.6" data-end="276.44">special, it is going to fail really, really early.</span> <span data-start="276.85" data-end="278.85">But like I said, this divides people.</span> <span data-start="278.85" data-end="280.86">Jason. How do you feel about this?</span> <span data-start="281.57" data-end="284.4">I mean, I like this idea for the fail early reason.</span> <span data-start="284.44" data-end="286.45">Like, that's a nice thing. If you if you pull this code</span> <span data-start="286.45" data-end="289.11">into a new project, it's going to tell you, "Hey,</span> <span data-start="289.45" data-end="291.87">this isn't a thing". Which is sort of exactly the message</span> <span data-start="291.87" data-end="292.91">you would want to receive.</span> <span data-start="293.24" data-end="296.5">But I also like that, you know, on the right hand side</span> <span data-start="296.54" data-end="299.21">of that colon, it's still just a module path.</span> </p>
<p><span data-start="299.21" data-end="301.67">So it's it's really clear for you when you're visually</span> <span data-start="301.67" data-end="303.8">looking through. This is the special part.</span> <span data-start="304" data-end="305.17">This is the regular part.</span> <span data-start="306.17" data-end="308.3">Yes. So all we need to do now is create the</span> <span data-start="309.13" data-end="310.14">build plugin, I guess.</span> <span data-start="310.39" data-end="312.01">So here's the config. The Rollup config.</span> <span data-start="312.39" data-end="314.81">You've seen this before if you've used Rollup, I'm going to</span> <span data-start="314.81" data-end="317.77">import this new plugin and add its to our list of plugins.</span> </p>
<p><span data-start="318.98" data-end="320.56">Now, all we need to do is write it.</span> <span data-start="321.4" data-end="324.44">Rollup has a one pager on how to write plugins,</span> <span data-start="324.78" data-end="327.49">but it's quite a long page.</span> <span data-start="327.99" data-end="330.91">But I have to say that the API is really well-designed</span> <span data-start="331.03" data-end="333.74">and the documentation is really well written.</span> <span data-start="334.24" data-end="335.91">So let's get started.</span> <span data-start="336.7" data-end="338.16">This is what Rollup plugins look like.</span> </p>
<p><span data-start="338.41" data-end="341.13">It's a function that returns an object.</span> <span data-start="342.33" data-end="343.92">It has a name as part of that.</span> <span data-start="343.96" data-end="345.71">And that's for error handling and logging.</span> <span data-start="346.26" data-end="349.51">But everything else, the rest of the object uses methods</span> <span data-start="349.55" data-end="351.59">that are called throughout the build that they're</span> <span data-start="351.76" data-end="352.89">essentially callbacks.</span> <span data-start="353.97" data-end="355.89">Rollup calls them hooks because they'rer hooks into the</span> <span data-start="355.89" data-end="356.89">build process.</span> </p>
<p><span data-start="357.27" data-end="359.06">The first hook we're going to look at is resolveID.</span> <span data-start="360.48" data-end="362.9">This is called for every module that's loaded.</span> <span data-start="363.11" data-end="365.48">So it's going to be called for the main file there, but</span> <span data-start="365.48" data-end="368.82">it's also going to be called for this import and everything</span> <span data-start="368.86" data-end="371.16">it imports, including dynamic imports.</span> <span data-start="371.49" data-end="374.24">The ID you get is the raw, unedited</span> <span data-start="374.74" data-end="377.45">import ID, so that's going to start with the dot-slash in</span> <span data-start="377.45" data-end="378.45">this case.</span> <span data-start="379.41" data-end="381.96">And in this case, it's going to include our special made up</span> <span data-start="382.25" data-end="383.38">URL scheme as well.</span> <span data-start="384.21" data-end="386">The second argument is the importer.</span> </p>
<p><span data-start="386.09" data-end="388.67">This is the path to the module which did the importing.</span> <span data-start="389.13" data-end="390.67">And this is the only time you get this piece of</span> <span data-start="390.67" data-end="391.68">information.</span> <span data-start="392.18" data-end="395.26">The job of the resolver is to return a full absolute</span> </p>
<p><span data-start="395.3" data-end="397.89">ID that doesn't need the importer anymore.</span> <span data-start="398.22" data-end="401.06">So, you know, any relative paths should be turned into</span> <span data-start="401.14" data-end="402.14">absolute paths.</span> <span data-start="402.65" data-end="405.69">Now, if you've used Rollup before you'll know that</span> <span data-start="405.73" data-end="408.15">it doesn't support node modules out of the box.</span> <span data-start="408.65" data-end="410.53">You need to add a plugin to be able to do that.</span> <span data-start="410.57" data-end="412.57">It's an official plugin, but you still need to add it.</span> <span data-start="413.36" data-end="416.08">All that is is a resolveID hook.</span> <span data-start="416.62" data-end="418.99">It sees these bare modules and it goes, oh, okay, well,</span> <span data-start="419.08" data-end="421">I'll try and find that in node modules.</span> <span data-start="421.41" data-end="424.08">But also if you want to create like path aliases</span> <span data-start="425" data-end="427.54">to make them work in Rollup, all you need to do is create a</span> <span data-start="427.54" data-end="428.75">resolveID plugin.</span> </p>
<p><span data-start="429.63" data-end="431.88">So we don't need to do anything with this first import.</span> <span data-start="432.26" data-end="434.89">We just need to handle the second one with the special URL.</span> <span data-start="436.01" data-end="437.01">So here we go.</span> <span data-start="437.47" data-end="439.72">The first thing I'm going to do is just exit early.</span> <span data-start="440.35" data-end="443.06">If it doesn't start with that prefix, actually, we're going</span> <span data-start="443.06" data-end="444.56">to do that sort of thing a few times.</span> </p>
<p><span data-start="444.56" data-end="446.31">So I'm going to pop that in a variable up here.</span> <span data-start="447.44" data-end="448.86">It's going to come up time and time again.</span> <span data-start="449.61" data-end="451.65">So there's an early exit. And it means if it doesn't start</span> <span data-start="451.65" data-end="454.49">with that prefix, we can hand it off to other plugins or</span> <span data-start="454.49" data-end="456.37">the default Rollup stuff.</span> <span data-start="457.37" data-end="460.04">Now, I'm going to remove that prefix and resolve it.</span> <span data-start="460.62" data-end="463.96">'this.resolve', this is a Rollup API.</span> </p>
<p><span data-start="464.25" data-end="466.5">And what it says is, like, take this ID and go</span> <span data-start="467.21" data-end="468.21">and find it for me.</span> <span data-start="469.71" data-end="471.01">It couldn't do it by default before.</span> <span data-start="471.05" data-end="472.55">But now we've removed the prefix.</span> <span data-start="473.09" data-end="475.3">Off it goes. And that's going to actually pass it back</span> <span data-start="475.3" data-end="477.85">through all the plugins that do resolving, including</span> <span data-start="478.3" data-end="479.89">our own. But we're going to ignore it because it doesn't</span> <span data-start="479.89" data-end="480.89">have the prefix anymore.</span> <span data-start="481.22" data-end="484.23">But it means like if you have a service worker in node</span> <span data-start="484.23" data-end="487.31">modules or if you have like path</span> <span data-start="487.35" data-end="489.65">aliases, it will all just work.</span> <span data-start="491.28" data-end="494.32">So if there's no match, just bail, and</span> <span data-start="494.36" data-end="496.57">that will cause an error eventually because it means that</span> <span data-start="496.57" data-end="497.95">we couldn't find that service worker.</span> <span data-start="498.41" data-end="500.99">Otherwise, I'm going to add that prefix back on so we can</span> <span data-start="500.99" data-end="501.95">pick it up later on.</span> </p>
<p><span data-start="503.37" data-end="505.33">But now we have an absolute path to the service worker.</span> <span data-start="505.66" data-end="507.08">We have achieved a thing.</span> <span data-start="507.67" data-end="508.67">We can try and build it.</span> <span data-start="509.33" data-end="512.13">Here we go. (sad trombone) It's not going to work.</span> <span data-start="512.63" data-end="515.76">But you can see in that error message it's failed because</span> <span data-start="515.76" data-end="517.13">of that special prefix.</span> <span data-start="517.47" data-end="520.43">But the rest of it is an absolute path to</span> <span data-start="520.47" data-end="523.02">the file as it is on my system.</span> <span data-start="523.47" data-end="526.02">So all we need to do is tell it how to load that script.</span> <span data-start="526.81" data-end="529.61">This is another hook "load" it gets the ID</span> <span data-start="530.11" data-end="531.69">as it's been fully resolved.</span> </p>
<p><span data-start="533.11" data-end="535.82">Again, we want to ignore if it doesn't have that prefix and</span> <span data-start="535.82" data-end="537.11">let other plugins deal with it.</span> <span data-start="538.03" data-end="540.53">And what we need to do now is return the content for this</span> <span data-start="540.53" data-end="543.41">module. So we could just actually make the module,</span> <span data-start="543.49" data-end="545.2">I'm going to do that and the return "hello".</span> <span data-start="545.75" data-end="548.21">And now we've done that, the project will actually build.</span> <span data-start="548.67" data-end="551.25">It's going to turn that fancy custom import into</span> <span data-start="551.96" data-end="552.96">"hello".</span> <span data-start="554.3" data-end="557.01">This is kind of silly, but just knowing those two things,</span> <span data-start="557.01" data-end="560.05">knowing how to resolve and knowing how to load, you can do</span> <span data-start="560.05" data-end="562.72">all sorts with that, that you can do all sorts of cool code</span> <span data-start="562.72" data-end="565.56">generation, loading of your files, that sort of thing.</span> </p>
<p><span data-start="565.77" data-end="567.43">I guess it's not so what we set out to do.</span> <span data-start="567.48" data-end="569.9">But like, you could totally see how this is basically like</span> <span data-start="569.9" data-end="571.19">a constant plugin.</span> <span data-start="572.52" data-end="575.65">Yes, exactly. And I've built constant plugins, and</span> <span data-start="575.65" data-end="576.9">that's exactly how you do it.</span> </p>
<p><span data-start="577.65" data-end="578.9">But let's improve on that.</span> <span data-start="578.9" data-end="581.37">So instead of just returning "hello", we need to bring the</span> <span data-start="581.37" data-end="584.41">service worker into the build system and return</span> <span data-start="584.54" data-end="587.16">it's URL. To bring a file into a build and can use</span> <span data-start="587.29" data-end="590.25">emitFile. This is a Rollup API for adding stuff into</span> <span data-start="590.25" data-end="591.25">the build.</span> <span data-start="592.08" data-end="594.75">I'm going to say this is a chunk and that's telling Rollup</span> <span data-start="594.84" data-end="597.21">like, "treat this like a JavaScript entry point".</span> <span data-start="597.55" data-end="600.09">So it should be processed by all the same plugins that deal</span> <span data-start="600.09" data-end="602.93">with JavaScript like minifiers, code splitting, and all of</span> <span data-start="602.93" data-end="603.93">that sort stuff.</span> <span data-start="604.51" data-end="605.64">It could also be 'asset'.</span> </p>
<p><span data-start="606.27" data-end="609.14">And if it's an asset, that's that's like an image, CSS,</span> <span data-start="610.98" data-end="611.98">I don't know, WebGL shaders.</span> <span data-start="612.9" data-end="615.36">Anything that's not JavaScript essentially you can process</span> <span data-start="615.36" data-end="616.36">in this way.</span> <span data-start="616.9" data-end="619.15">I'm going to give it the ID and that's telling Rollup where</span> <span data-start="619.15" data-end="621.91">to find it. So we've removed the prefix again</span> <span data-start="622.91" data-end="624.87">and I'm going to give it a file name. And this is not</span> <span data-start="624.87" data-end="626.03">something you would usually do.</span> <span data-start="626.74" data-end="629.96">What this does is it overwrites the naming</span> <span data-start="629.96" data-end="632.21">system that Rollup would usually use because Rollup would</span> <span data-start="632.21" data-end="633.96">usually add a hash to this file.</span> <span data-start="634.25" data-end="636.21">But with service worker, you don't want its name to be</span> <span data-start="636.21" data-end="638.51">changing. You want it to be in a static location.</span> </p>
<p><span data-start="639.17" data-end="640.26">So that's how we achieved that.</span> <span data-start="641.18" data-end="642.97">Actually, I'd say this is this is something that you would</span> <span data-start="643.01" data-end="644.55">offer to the user as configuration.</span> <span data-start="644.89" data-end="646.76">So I'm going to do that. I'm going to add an option object</span> <span data-start="646.76" data-end="647.76">to the top here.</span> <span data-start="648.14" data-end="651.48">And I'm just going to like change the variable</span> <span data-start="651.48" data-end="653.27">down here. So it's using that.</span> </p>
<p><span data-start="653.27" data-end="655.31">So that means the user can change the path of the service</span> <span data-start="655.31" data-end="658.28">worker, the file name, all of that sort of stuff.</span> <span data-start="660.15" data-end="663.11">Now, what we need to do is get the URL for this file and</span> <span data-start="663.28" data-end="664.87">strap in. It's a bit of magic.</span> <span data-start="665.62" data-end="666.62">Woo! There it goes.</span> </p>
<p><span data-start="667.62" data-end="670.04">So I'm returning the import.meta, and</span> <span data-start="670.83" data-end="673.67">then this sort of magic string that ends in a file ID.</span> <span data-start="674.04" data-end="675.54">And we've got the file ID from emitFile.</span> <span data-start="676.79" data-end="679.67">Rollup will see this and it will turn it into a URL for the</span> <span data-start="679.76" data-end="682.22">resource. So here's what that looks like.</span> <span data-start="683.01" data-end="685.3">Here's the input and here's the output.</span> <span data-start="686.05" data-end="687.51">So it's created this URL object.</span> <span data-start="688.14" data-end="690.97">And it does that so it can create a relative</span> </p>
<p><span data-start="691.14" data-end="694.02">URL from this script to</span> <span data-start="694.23" data-end="696.98">the service worker. Because on the web, if you've got an</span> <span data-start="697.06" data-end="700.07">image tag with a source or whatever, or</span> <span data-start="700.65" data-end="702.82">when you're calling serviceWorker.register(), by default</span> <span data-start="702.82" data-end="704.28">URLs are relative to the page.</span> </p>
<p><span data-start="704.57" data-end="707.2">But Rollup doesn't know anything about the page.</span> <span data-start="707.28" data-end="709.08">So it creates this, this script relative URL.</span> <span data-start="710.37" data-end="711.58">You can actually configure this in Rollup.</span> <span data-start="712.96" data-end="715.5">So you can tell it, "Hey, all my stuff is actually at the</span> <span data-start="715.5" data-end="716.92">roots of the origin.</span> <span data-start="717.38" data-end="718.84">All you need to do is add a slash to the start".</span> <span data-start="718.84" data-end="721.09">And obviously that will clean up the code a bit.</span> <span data-start="721.51" data-end="722.76">It just doesn't do it by default.</span> <span data-start="724.59" data-end="727.26">But also in our build, we've got a service worker, so that</span> <span data-start="727.39" data-end="728.39">bit is working.</span> <span data-start="729.26" data-end="732.06">All we have to do now is deal with these two things, the</span> <span data-start="732.39" data-end="733.56">version and the assets.</span> <span data-start="735.31" data-end="736.9">We'll handle the the assets first.</span> <span data-start="738.19" data-end="741.32">To do this, we need to know the full details of</span> <span data-start="741.32" data-end="744.36">the build. So because we need those hashed file names</span> <span data-start="744.36" data-end="745.4">and all of that sort of stuff.</span> </p>
<p><span data-start="745.9" data-end="748.53">So we need a hook that is towards the end of the build</span> <span data-start="748.53" data-end="749.53">process.</span> <span data-start="750.03" data-end="751.03">We're gonna use generateBundle.</span> <span data-start="751.79" data-end="754.54">This happens just before things are written to disk.</span> <span data-start="755.33" data-end="758.42">The options parameter, you know,</span> <span data-start="758.5" data-end="760.92">it's the output options. It's not very interesting for us</span> <span data-start="760.92" data-end="761.92">in this case.</span> <span data-start="762.84" data-end="765.97">But this, this is where</span> <span data-start="766.22" data-end="767.22">the party is at.</span> <span data-start="767.63" data-end="769.64">This is full of interesting details about</span> <span data-start="770.64" data-end="771.43">the build.</span> <span data-start="771.43" data-end="774.47">It's a JavaScript object where the key is the file name</span> <span data-start="774.64" data-end="776.31">and the object has details on the file.</span> </p>
<p><span data-start="776.31" data-end="778.98">So this is an asset. So you can see it's got a file name</span> <span data-start="779.4" data-end="782.23">and it's got a buffer representing the content.</span> <span data-start="782.65" data-end="785.9">But for chunks, look at all this all this stuff</span> <span data-start="785.9" data-end="787.2">we get. This is amazing.</span> <span data-start="788.82" data-end="791.03">It tells us things like the imports and the exports of the</span> <span data-start="791.03" data-end="793.12">file. I've used this and other plugins</span> <span data-start="794.04" data-end="796.83">if I'm generating HTML and I'm putting a script tag</span> <span data-start="797.41" data-end="798.42">on the page.</span> <span data-start="799.33" data-end="801.17">I know that that script is just going to import other</span> <span data-start="801.29" data-end="803.63">scripts and I want to preload those things.</span> <span data-start="803.92" data-end="804.92">Well, I can do that here.</span> <span data-start="806.34" data-end="809.22">So this will tell me which things it's going to immediately</span> <span data-start="809.43" data-end="811.3">import so I can turn those into preloads.</span> </p>
<p><span data-start="812.64" data-end="815.06">Anyway, loads of interesting info.</span> <span data-start="816.22" data-end="817.23">We're going to make use of this.</span> <span data-start="818.14" data-end="820.35">In the generateBundle hook, I'm going to get that service</span> <span data-start="820.35" data-end="823.27">worker chunk just from that output option, because that's</span> <span data-start="823.48" data-end="824.48">the file name of it.</span> <span data-start="825.03" data-end="827.32">And then we need to figure out which assets the</span> <span data-start="827.99" data-end="830.32">service worker needs to know about the things that it wants</span> <span data-start="830.32" data-end="831.32">to cache.</span> </p>
<p><span data-start="831.95" data-end="834.91">But iterate over the bundle, get the values, and I'm going</span> <span data-start="834.91" data-end="837.54">to get everything except the service worker item itself.</span> <span data-start="838.25" data-end="841.04">If a service worker caches itself like</span> <span data-start="841.71" data-end="844.09">it doesn't cause the world to end, like you might imagine,</span> <span data-start="844.17" data-end="845.92">it's it's just a bit wasteful.</span> <span data-start="847.26" data-end="848.8">We definitely designed around that.</span> <span data-start="848.8" data-end="850.38">We were worried people would do that.</span> <span data-start="850.43" data-end="852.76">So it's actually OK. But this is a point where people might</span> <span data-start="852.76" data-end="855.43">want to configure the things which are actually cached by</span> <span data-start="855.43" data-end="857.89">the service worker. So what I'm going to do is add another</span> <span data-start="857.93" data-end="861.35">option here. 'filterAssets' returns true by default.</span> <span data-start="862.02" data-end="863.15">And I'm going to call it down here.</span> <span data-start="865.27" data-end="866.73">Slight complicating factor.</span> </p>
<p><span data-start="866.86" data-end="869.32">We want these paths to be relative to the service worker</span> <span data-start="869.32" data-end="872.49">itself. And unfortunately, Rollup doesn't give us access</span> <span data-start="872.49" data-end="875.66">to it's URL resolving magic stuff.</span> <span data-start="875.74" data-end="877.08">I've filed a issue for that.</span> <span data-start="877.95" data-end="879.66">But we're gonna have to do ourselves this time.</span> <span data-start="880.37" data-end="882.67">So I'm going to use node's posix path resolving</span> <span data-start="883.33" data-end="886">stuff. Another reason I'm doing that is because posix paths</span> <span data-start="886.04" data-end="888.76">have the forward slash and that's the same as URLs.</span> <span data-start="889.55" data-end="890.92">So we can we can rely on that.</span> </p>
<p><span data-start="891.88" data-end="894.85">And then down here, this is how I curate the relative URLs.</span> <span data-start="895.05" data-end="897.68">This is done by saying "give me the relative path from</span> <span data-start="898.06" data-end="901.02">the folder that the service worker is in to the item</span> <span data-start="901.27" data-end="902.27">from the build".</span> <span data-start="903.4" data-end="904.4">And now we've got that.</span> </p>
<p><span data-start="904.77" data-end="906.4">I can prepend that to the file.</span> <span data-start="906.77" data-end="909.23">So this bundle object is live</span> <span data-start="909.73" data-end="912.11">in that any changes I make here are actually going to be</span> <span data-start="912.11" data-end="914.82">written to disk. So here I'm just taking the code for the</span> <span data-start="914.82" data-end="917.2">service worker chunk, adding that</span> <span data-start="917.83" data-end="921.04">assets line to the start, using JSON.stringify to correctly</span> <span data-start="921.12" data-end="922.12">escape everything.</span> <span data-start="922.41" data-end="924.5">And now that will be part of the service worker.</span> <span data-start="925.38" data-end="927.25">And if we build, there it is.</span> <span data-start="927.29" data-end="929.09">There it is in the output. The assets.</span> <span data-start="930.84" data-end="933.51">We've created a problem, though. And this is something</span> <span data-start="933.84" data-end="935.89">that catches a lot of people out when they're doing service</span> <span data-start="935.89" data-end="938.51">workers. It's this it's easy to think that the service</span> <span data-start="938.76" data-end="940.43">worker is caching files, but it's not.</span> </p>
<p><span data-start="940.52" data-end="941.52">It's caching URLs.</span> <span data-start="942.14" data-end="944.48">And we don't want .HTML in our URLs.</span> <span data-start="944.64" data-end="947.11">We don't want index.HTML in our URLs.</span> <span data-start="947.98" data-end="948.98">So we need to fix that.</span> <span data-start="949.86" data-end="952.11">Back in our plugin, this is where we were before.</span> <span data-start="952.49" data-end="954.2">How can we solve a problem like this?</span> <span data-start="955.28" data-end="957.24">Regular expressions. Of course, it's Regex.</span> </p>
<p><span data-start="960.04" data-end="962.16">I'm not going to go through how this works.</span> <span data-start="962.95" data-end="963.96">I see a back reference in there? I'm not even..</span> <span data-start="966.25" data-end="967.33">I love back reference.</span> <span data-start="968.17" data-end="970.5">I often say that regular expressions are write-only.</span> <span data-start="971.3" data-end="972.88">You can't read them again afterwards.</span> </p>
<p><span data-start="973.42" data-end="976.05">But trust me, this is removing the .HTML and it's removing</span> <span data-start="976.05" data-end="977.47">the index.HTML as well.</span> <span data-start="978.14" data-end="980.35">This could land us with an empty string, which is a problem</span> <span data-start="980.35" data-end="983.02">because that will resolve to the service worker script</span> <span data-start="983.18" data-end="985.6">itself. So in that case, just gonna output a dot.</span> <span data-start="987.31" data-end="988.9">And that solved the problem. There we go.</span> <span data-start="989.19" data-end="991.78">Index.HTML there is replaced with a dot.</span> </p>
<p><span data-start="993.07" data-end="994.44">OK. Last thing.</span> <span data-start="994.69" data-end="996.99">Just need to deal with that version thing.</span> <span data-start="997.49" data-end="999.45">Thankfully we're most of the way there already.</span> <span data-start="999.82" data-end="1002.16">This is going to be a hash, so I'm going to include nodes</span> <span data-start="1002.54" data-end="1003.54">hashing stuff.</span> </p>
<p><span data-start="1004.5" data-end="1007.08">Down in the generate function, create one of these objects.</span> <span data-start="1007.08" data-end="1010">I picked 'sha1' because</span> <span data-start="1010.67" data-end="1012.84">I've heard of it before, and it wasn't MD5.</span> <span data-start="1013.59" data-end="1014.55">It's secure.</span> <span data-start="1014.55" data-end="1016.01">I'd heard it was worse. Yeah.</span> <span data-start="1016.13" data-end="1017.88">This is, this is very secure.</span> </p>
<p><span data-start="1019.22" data-end="1021.18">I mean, yeah, security doesn't matter in this case.</span> <span data-start="1021.51" data-end="1022.51">It's just, it's just for hashing.</span> <span data-start="1024.1" data-end="1026.6">Oh don't quote me on that. Like security generally matters.</span> <span data-start="1027.1" data-end="1028.27">[Laughing] Jake Archibald, security doesn't matter.</span> </p>
<p><span data-start="1030.9" data-end="1032.11">What a quote to take out of context!</span> <span data-start="1032.94" data-end="1036.03">OK, so now here I'm adding</span> <span data-start="1036.49" data-end="1037.74">everything to that hash.</span> <span data-start="1037.78" data-end="1040.74">So it's either the the source or</span> <span data-start="1040.74" data-end="1043.03">the code, depending on whether it's an asset or whether</span> <span data-start="1043.03" data-end="1044.04">it's a chunk.</span> <span data-start="1045.41" data-end="1047.87">And now I could get a hex version of that hash and</span> <span data-start="1048.42" data-end="1050.38">include it in the old output there.</span> </p>
<p><span data-start="1051.96" data-end="1053.5">And that's really it. That's it.</span> <span data-start="1053.55" data-end="1055.76">We can see that the hash is now in the service worker.</span> <span data-start="1057.13" data-end="1060.14">There's a couple of caveats here by</span> <span data-start="1060.18" data-end="1061.85">editing the source right at the end.</span> <span data-start="1062.1" data-end="1064.39">That was after source maps were generated.</span> <span data-start="1064.51" data-end="1066.47">So we have just broken source maps.</span> </p>
<p><span data-start="1066.89" data-end="1067.89">Just for the service worker.</span> <span data-start="1068.89" data-end="1070.56">I filed an issue with Rollup because</span> <span data-start="1072.11" data-end="1073.9">I would like there to be an easier way to do this.</span> <span data-start="1074.61" data-end="1076.03">So hopefully they can add something.</span> <span data-start="1076.94" data-end="1079.28">We could we could probably work around this by adding those</span> <span data-start="1079.28" data-end="1081.74">blank lines in a transformed step</span> <span data-start="1082.45" data-end="1084.16">so we can fill them in later because that that will -</span> <span data-start="1086.2" data-end="1088.29">those extra two lines at the top, will at least be taken</span> <span data-start="1088.66" data-end="1090.42">into consideration with the source maps.</span> <span data-start="1091.12" data-end="1092.67">I don't know. It would be good if there's a proper way of</span> <span data-start="1092.67" data-end="1093.67">doing this. But anyway.</span> <span data-start="1095.13" data-end="1097.42">That is it. That is the full plugin.</span> <span data-start="1099.01" data-end="1102.01">So, Jason, how would you do that</span> <span data-start="1102.3" data-end="1103.3">in webpack?</span> </p>
<p><span data-start="1103.6" data-end="1106.18">Right. So building plugins for webpack works a little</span> <span data-start="1106.56" data-end="1109.23">bit differently. And to illustrate this, I'm going to use a</span> <span data-start="1109.23" data-end="1111.65">fairly similar approach and naming to what we saw</span> <span data-start="1112.44" data-end="1113.9">in Jake's Rollup version.</span> <span data-start="1114.19" data-end="1116.23">Much like with Rollup, the place where we're gonna start</span> <span data-start="1116.32" data-end="1117.32">will be the bundler config.</span> <span data-start="1118.78" data-end="1122.24">Now, a typical webpack.config.js file specifies</span> <span data-start="1122.41" data-end="1124.62">some entry points, which are going to be the modules where</span> <span data-start="1124.62" data-end="1125.62">bundling starts.</span> </p>
<p><span data-start="1126.45" data-end="1128.87">Some options for the format and location of files</span> <span data-start="1129.37" data-end="1131.83">generated on disk and plugins, which is what we're</span> <span data-start="1132.17" data-end="1133.17">concerned with today.</span> <span data-start="1133.88" data-end="1136.54">All we need to do is import our plugin that we're going to</span> <span data-start="1136.54" data-end="1138.84">write and then add it to the plugin's array.</span> </p>
<p><span data-start="1140.8" data-end="1143.68">At its core, a webpack plugin is really just an object</span> <span data-start="1143.8" data-end="1146.85">with an apply method and that apply method gets passed</span> <span data-start="1147.14" data-end="1148.31">the compiler instance.</span> <span data-start="1148.68" data-end="1151.48">So wait one second. So this is like I see you using classes</span> <span data-start="1151.48" data-end="1154.23">here. So in Rollup, we were using the function which</span> <span data-start="1154.23" data-end="1156.65">returned an object. But in webpack land, it's it's all</span> <span data-start="1156.65" data-end="1157.65">class based?</span> <span data-start="1157.9" data-end="1160.03">So technically, webpack does not care.</span> <span data-start="1160.36" data-end="1162.07">It just needs an object with in the apply method.</span> <span data-start="1162.15" data-end="1165.7">But all of the webpack core modules</span> <span data-start="1165.74" data-end="1168.74">are classes. And I think as a result of that, all of</span> <span data-start="1168.74" data-end="1171.87">the ecosystem plugins tend to be classes just because</span> <span data-start="1172" data-end="1174.83">when people import it, they expect to instantiate with new.</span> <span data-start="1175.46" data-end="1177.67">You could totally write a webpack plugin that was a</span> <span data-start="1177.67" data-end="1178.92">function that returns an object.</span> </p>
<p><span data-start="1179.55" data-end="1181.55">I was even actually tempted to do that for this talk to</span> <span data-start="1181.55" data-end="1183.43">make it look more like the Rollup plugin.</span> <span data-start="1184.47" data-end="1187.26">But you know we'll stick with the thing people actually do.</span> <span data-start="1188.64" data-end="1191.52">All right. So if you member in Rollup, plugins</span> <span data-start="1191.64" data-end="1194.77">define special hook methods that get called in response to</span> <span data-start="1194.85" data-end="1197.56">events. In webpack, we do the opposite.</span> </p>
<p><span data-start="1197.98" data-end="1200.32">Your plugin taps into events.</span> <span data-start="1201.32" data-end="1203.49">And so what we want to do is want to handle a special</span> <span data-start="1203.49" data-end="1205.7">service-worker:import prefix.</span> <span data-start="1206.11" data-end="1208.32">And so to do that, we need to tap into normalModuleFactory.</span> <span data-start="1209.58" data-end="1212.04">And just to preempt because everybody gets confused at</span> <span data-start="1212.04" data-end="1215.29">this. Normal modules are source</span> <span data-start="1215.29" data-end="1217.79">modules. These are the code you write, the code you</span> <span data-start="1218.25" data-end="1220.75">get from NPM, code that you're going to put in your</span> <span data-start="1221.25" data-end="1223.8">application. There are other types of modules, which</span> <span data-start="1224.22" data-end="1226.89">is why there is other module factories for things like</span> <span data-start="1227.39" data-end="1230.47">loaders. Basically, they're more on the infrastructure</span> <span data-start="1230.47" data-end="1232.77">side of things. So if what we're looking to do here is</span> <span data-start="1232.77" data-end="1235.14">resolve our own import, we use normalModuleFactory.</span> </p>
<p><span data-start="1236.64" data-end="1239.81">And so similar with Rollup, anytime we tap into something,</span> <span data-start="1239.86" data-end="1242.4">we want to pass it a name, which is the name for our</span> <span data-start="1242.48" data-end="1245.03">plugin. And this gets used for debugging and logging</span> <span data-start="1245.4" data-end="1248.45">purposes. And also when taking performance profiles.</span> <span data-start="1250.53" data-end="1252.33">So within normalModuleFactory, we can</span> <span data-start="1253.62" data-end="1256.25">now hook into webpack's resolver.</span> <span data-start="1257.04" data-end="1259.25">And this gives us a reference to webpack's own resolve</span> <span data-start="1259.25" data-end="1261.75">function, which is the thing that sort of handles finding</span> <span data-start="1261.75" data-end="1263.38">modules and loading them from disk.</span> <span data-start="1264.09" data-end="1266.93">But it also lets us return our own custom resolver</span> <span data-start="1266.93" data-end="1269.93">function, which gets passed a dependency description</span> <span data-start="1270.51" data-end="1272.81">and a callback because it's asynchronous.</span> <span data-start="1273.1" data-end="1276.18">And so this function we can call the original</span> <span data-start="1276.18" data-end="1278.73">resolve function. We can do something custom, we can</span> <span data-start="1279.06" data-end="1280.06">combine the two.</span> <span data-start="1280.94" data-end="1283.02">To make things easier, we're just going to take those three</span> <span data-start="1283.02" data-end="1286.11">bits of information that we have and pass them to a new</span> <span data-start="1286.15" data-end="1288.57">resolveID method that we're going to write.</span> </p>
<p><span data-start="1289.03" data-end="1290.37">And that sort of everything we needed from apply.</span> <span data-start="1292.83" data-end="1296.16">So our resolveID method is going to be called</span> <span data-start="1296.16" data-end="1299.17">for each import specifier in the app</span> <span data-start="1299.42" data-end="1302.38">with a description of the dependency, that</span> <span data-start="1302.67" data-end="1305.17">original result function from webpack, and the callback to</span> <span data-start="1305.17" data-end="1306.17">call when we're done.</span> </p>
<p><span data-start="1307.05" data-end="1310.09">A dependency description is an object with context</span> <span data-start="1310.13" data-end="1311.34">and request properties.</span> <span data-start="1311.8" data-end="1314.31">Context is the directory of the module that's doing</span> <span data-start="1315.14" data-end="1318.18">the importing. So in this case, dot-slash and</span> <span data-start="1318.18" data-end="1321.44">request is the unmodified import specifiers.</span> </p>
<p><span data-start="1321.44" data-end="1324.27">So in this case, it includes our service worker prefix and</span> <span data-start="1324.61" data-end="1326.9">also the relative path to that file on disk.</span> <span data-start="1327.15" data-end="1329.78">So similar to Rollup, the first thing we want to do is</span> <span data-start="1329.9" data-end="1332.95">figure out whether this is an import that has our</span> <span data-start="1332.99" data-end="1334.24">prefix that we want to handle.</span> <span data-start="1335.24" data-end="1337.95">If it isn't, then we can just call webpacks original</span> <span data-start="1337.95" data-end="1340.58">resolve method. It will do what it would normally do.</span> <span data-start="1340.62" data-end="1342.42">Since there's no prefix, we don't really care about that</span> <span data-start="1342.46" data-end="1343.42">module.</span> <span data-start="1344.09" data-end="1346.75">But if it does have the prefix, we need to remove that</span> <span data-start="1347.17" data-end="1350.72">prefix and then pass it through resolve.</span> <span data-start="1351.84" data-end="1354.76">And so if the module can't be resolved, we can just forward</span> <span data-start="1354.85" data-end="1356.1">that error up. That will break the build.</span> <span data-start="1356.39" data-end="1358.06">There will be an error in the console saying, "Hey,</span> <span data-start="1358.64" data-end="1359.64">couldn't find module SW/index.js".</span> </p>
<p><span data-start="1362.65" data-end="1366.15">If it does work, then it'll pass us back a new dependancy</span> <span data-start="1366.15" data-end="1369.49">object where the request property is a fully resolved</span> <span data-start="1369.49" data-end="1370.49">disk path.</span> <span data-start="1372.16" data-end="1374.49">The thing is, we don't actually want to resolve this module</span> <span data-start="1374.53" data-end="1375.53">to a path.</span> <span data-start="1376.37" data-end="1379.37">Right. we want to resolve this module to a string somehow.</span> <span data-start="1379.41" data-end="1381.41">Right. This the string that contains the location of our</span> <span data-start="1381.41" data-end="1382.42">service worker.</span> <span data-start="1383.04" data-end="1384.92">And so to do that, we need to sort of â€” We need to come up</span> <span data-start="1384.92" data-end="1388.09">with a way of producing a virtual module.</span> <span data-start="1388.17" data-end="1389.17">Even though we're inside of the resolver.</span> <span data-start="1390.67" data-end="1393.89">Essentially, we want to intercept this service worker</span> <span data-start="1393.89" data-end="1397.1">prefix request and then resolve it to a module</span> <span data-start="1397.1" data-end="1399.39">that we create on the fly. It doesn't actually exist.</span> <span data-start="1399.85" data-end="1403.1">That just exports the string URL for our service worker.</span> <span data-start="1404.85" data-end="1407.69">And then one thing we do need to account for here is when</span> <span data-start="1407.69" data-end="1410.44">when we're working with URLs in webpack, we need to make</span> <span data-start="1410.69" data-end="1413.49">sure that we respect any webpack public path</span> <span data-start="1413.86" data-end="1415.32">magic global that has been set.</span> </p>
<p><span data-start="1415.91" data-end="1418.53">And so this is either the output.public_path</span> <span data-start="1419.41" data-end="1422.41">configuration value or some value that has been set</span> <span data-start="1422.46" data-end="1423.46">at runtime.</span> <span data-start="1423.92" data-end="1426.08">Right. OK. So this is this is another difference from</span> <span data-start="1426.21" data-end="1429.5">Rollup. So Rollup had to do some of the magic</span> <span data-start="1429.5" data-end="1432.05">around, like, you know, resolving URLs</span> <span data-start="1432.59" data-end="1435.3">and stuff, whereas here you've just got a string,</span> <span data-start="1435.64" data-end="1437.68">which is like where in the webroot is it.</span> <span data-start="1438.18" data-end="1439.76">Right. Yeah. So like Rollup.</span> <span data-start="1440.35" data-end="1443.39">You know, they have automation here to sort of give</span> <span data-start="1443.39" data-end="1444.77">you module relative paths.</span> <span data-start="1445.6" data-end="1449.15">In webpack, it's a configuration value.</span> <span data-start="1449.61" data-end="1452.07">And the nice thing is, you know, because everybody</span> <span data-start="1453.24" data-end="1456.07">uses that configuration value, all plugins tend to respect</span> <span data-start="1456.11" data-end="1458.78">it. So here, if we combine these two strings, we'll get</span> <span data-start="1459.24" data-end="1461.83">the slash, which is sort of our default webpack public path</span> <span data-start="1461.83" data-end="1464.91">value. And that means that the result of this import</span> <span data-start="1464.96" data-end="1467.21">will be the service workers</span> </p>
<p><span data-start="1468.92" data-end="1470.5">URL. The thing is, we haven't actually explained how to</span> <span data-start="1470.5" data-end="1472.01">construct a virtual module yet.</span> <span data-start="1472.21" data-end="1473.34">We know what we want to do.</span> <span data-start="1473.76" data-end="1474.76">We don't know how to do it.</span> <span data-start="1476.05" data-end="1478.72">So first, we want to start with that code that we want to</span> <span data-start="1478.72" data-end="1481.39">generate. And you'll notice here, I've parameterised the</span> <span data-start="1482.22" data-end="1485.27">URL from that code string, and</span> <span data-start="1485.27" data-end="1487.15">that's because we want to make that configurable.</span> </p>
<p><span data-start="1487.19" data-end="1490.15">So in our constructor, we'll accept an output parameter.</span> <span data-start="1490.61" data-end="1493.61">The developer can pass us the URL to use.</span> <span data-start="1493.65" data-end="1496.74">We'll store that and then we can inject it into our code</span> <span data-start="1496.9" data-end="1499.95">by JSON.stringifying it, which will escape it and</span> <span data-start="1500.07" data-end="1501.08">wrap it in quotes.</span> <span data-start="1502.08" data-end="1504.7">Then the last bit is to take our piece of code and pass</span> <span data-start="1505" data-end="1506.87">it back to webpack and to do this.</span> <span data-start="1507.25" data-end="1509.13">We're going to use something called RawModule</span> <span data-start="1510.21" data-end="1512.17">and we're going to import this from webpack core.</span> <span data-start="1512.88" data-end="1516.01">So RawModule is basically</span> <span data-start="1516.01" data-end="1518.72">a way for us to provide code back to webpack in the same</span> <span data-start="1518.89" data-end="1521.89">module format as it</span> <span data-start="1521.89" data-end="1524.06">would expect modules loaded from disk.</span> <span data-start="1524.43" data-end="1527.31">And the reason why this matters is we need to provide</span> <span data-start="1527.31" data-end="1530.31">webpack with an object that has a source method</span> <span data-start="1530.44" data-end="1532.73">that returns is a code string and an identifier</span> <span data-start="1533.48" data-end="1536.19">method that returns some sort of a unique identifier for</span> <span data-start="1536.19" data-end="1538.86">that module. In our case, based on the code string.</span> </p>
<p><span data-start="1539.49" data-end="1542.49">And in doing this, webpack will actually grab the code that</span> <span data-start="1542.49" data-end="1545.29">we send back to it and avoid ever going to disk to resolve</span> <span data-start="1545.29" data-end="1547.25">this module. It will just use whatever we pass.</span> <span data-start="1548.83" data-end="1551.54">So now we have our import resolving to the</span> <span data-start="1551.79" data-end="1554.67">URL of the service worker, but that URL doesn't exist</span> <span data-start="1554.75" data-end="1556.88">because we have not yet generated our service worker.</span> <span data-start="1557.3" data-end="1558.3">Let's do that.</span> <span data-start="1558.63" data-end="1560.13">For this, we need a new plugin hook.</span> <span data-start="1562.14" data-end="1564.81">And so when we need a new plugin hook, we have to jump back</span> <span data-start="1564.81" data-end="1565.81">in to Apply.</span> <span data-start="1566.18" data-end="1568.89">We need information that's going to be</span> <span data-start="1569.23" data-end="1571.85">codified into the service worker, those version and assets</span> <span data-start="1571.85" data-end="1574.86">globals. And to get this, we need to tap into something</span> <span data-start="1574.86" data-end="1577.49">that happens at the end of the build, once that information</span> <span data-start="1577.53" data-end="1578.49">is available.</span> <span data-start="1579.15" data-end="1580.91">So for this, we can use the emit hook.</span> </p>
<p><span data-start="1581.74" data-end="1583.83">You'll also notice we're using tapAsync here.</span> <span data-start="1583.91" data-end="1586.58">And this is because our emit hook is going to be</span> <span data-start="1586.58" data-end="1589.25">asynchronous. And we want a hold back compilation until</span> <span data-start="1589.25" data-end="1590.25">we're done working.</span> <span data-start="1591.37" data-end="1594.13">So the emit hook gets past a compilation instance</span> <span data-start="1594.42" data-end="1597.38">and a callback, which we're going to forward onto a new</span> <span data-start="1597.38" data-end="1598.8">method just to keep things clean.</span> <span data-start="1600.8" data-end="1603.22">In webpack, each compile pass is referred to as a</span> <span data-start="1603.26" data-end="1605.93">compilation, and the main thing that we're interested here</span> <span data-start="1606.22" data-end="1609.48">is the generated assets, which are an object</span> <span data-start="1609.52" data-end="1612.48">where the keys are file names and the values</span> <span data-start="1612.56" data-end="1613.94">are asset descriptors.</span> <span data-start="1614.81" data-end="1617.61">I recognize this. This is the same as the Rollup</span> <span data-start="1618.03" data-end="1619.49">bundle thing, right?</span> <span data-start="1619.65" data-end="1620.65">Like we had in generateBundle.</span> <span data-start="1620.9" data-end="1622.7">Yeah, it's really similar. I don't think I actually</span> <span data-start="1622.7" data-end="1625.03">realized until we were sort of looking at these things side</span> <span data-start="1625.03" data-end="1627.37">by side. They contain really similar metadata.</span> </p>
<p><span data-start="1628.49" data-end="1629.83">So it has, you know, the dependencies.</span> <span data-start="1630.45" data-end="1632.29">And "is this an entry chunk?". And all that information.</span> <span data-start="1632.87" data-end="1636.13">It's also for both JavaScript and non JavaScript assets.</span> <span data-start="1637.25" data-end="1640.26">In both cases, there's a source method on</span> <span data-start="1640.26" data-end="1643.22">the asset descriptor that will return either a buffer</span> <span data-start="1643.59" data-end="1646.64">with the non JavaScript asset contents or</span> <span data-start="1646.72" data-end="1649.47">a string with the JavaScript code.</span> <span data-start="1649.97" data-end="1653.14">So we need a list of files for the service worker to cache</span> <span data-start="1653.39" data-end="1656.11">and to get that, we could just take the keys of the assets</span> <span data-start="1656.11" data-end="1657.11">object.</span> <span data-start="1657.57" data-end="1660.44">Similar to with the Rollup plugin, though, it's generally a</span> <span data-start="1660.48" data-end="1663.28">good idea to make it possible to filter these assets before</span> <span data-start="1663.28" data-end="1665.32">they get embedded into the service worker just to avoid a</span> <span data-start="1665.32" data-end="1666.32">huge list.</span> </p>
<p><span data-start="1666.57" data-end="1669.83">So we'll add a filterAssets constructor parameter</span> <span data-start="1669.91" data-end="1672.66">that a developer can set and provide a function that takes</span> <span data-start="1672.66" data-end="1675.42">a file name and returns a boolean indicating whether that</span> <span data-start="1675.42" data-end="1676.71">asset should be in the list.</span> <span data-start="1678.71" data-end="1680.09">Now we have our list of asset file names.</span> <span data-start="1681.38" data-end="1684.22">The next step is to calculate a version based on a hash of</span> <span data-start="1684.3" data-end="1685.3">their contents.</span> <span data-start="1686.18" data-end="1687.6">And so to do this, we need to</span> <span data-start="1689.14" data-end="1692.39">pull in the createHash method from node's crypto module.</span> <span data-start="1693.06" data-end="1696.06">Then we'll loop over each file name in our filtered list</span> <span data-start="1696.6" data-end="1698.98">and add its corresponding assets source, which will be that</span> <span data-start="1698.98" data-end="1701.48">code, string, or buffer to the hash content.</span> </p>
<p><span data-start="1703.44" data-end="1706.11">Then our version string is just going to be a hex digest of</span> <span data-start="1706.11" data-end="1708.78">the combined contents of all of those assets.</span> <span data-start="1709.91" data-end="1711.66">So that's the magic version global done.</span> <span data-start="1712.37" data-end="1714.87">Now we can do the assets magic global.</span> </p>
<p><span data-start="1716.46" data-end="1719.17">So as Jake explained in the Rollup walkthrough our assets</span> <span data-start="1719.17" data-end="1722.09">array contains file names, but our service worker needs to</span> <span data-start="1722.09" data-end="1723.09">work with URLs.</span> <span data-start="1723.88" data-end="1726.84">And so to fix this, we need to prepend any configured</span> <span data-start="1726.84" data-end="1729.93">public path value to the names in</span> <span data-start="1729.93" data-end="1732.93">case we're deploying somewhere that isn't the root domain.</span> </p>
<p><span data-start="1733.68" data-end="1736.69">Right, so this is it again, this is gonna be simpler than</span> <span data-start="1736.69" data-end="1739.02">it was with the Rollup case, because you can just got this</span> <span data-start="1739.06" data-end="1740.06">string that you can add to the start.</span> <span data-start="1740.73" data-end="1743.4">Right. So because everyone knows to configure that public</span> <span data-start="1743.4" data-end="1746.07">path, we can basically count on it being there.</span> <span data-start="1746.07" data-end="1748.7">If it's unsent, we'll just use slash, but we're gonna be</span> <span data-start="1748.7" data-end="1750.45">able to resolve these things at build time.</span> <span data-start="1751.74" data-end="1753.83">So I'm showing some of my biases here.</span> <span data-start="1753.87" data-end="1757">But like, I think this is way</span> <span data-start="1757" data-end="1758.83">more complicated than the Rollup solution.</span> <span data-start="1759.04" data-end="1762.17">But it's interesting seeing these little details that</span> <span data-start="1762.5" data-end="1764.59">like I'm like, "Oh, I wish I wish Rollup had that!".</span> <span data-start="1764.76" data-end="1766.84">I mean, I know why it doesn't, but oh that would be so much</span> <span data-start="1766.84" data-end="1769.14">simpler for me if it just had like a public path,</span> <span data-start="1769.97" data-end="1770.97">like string or whatever.</span> </p>
<p><span data-start="1771.14" data-end="1773.31">Yeah. Maybe that's part of Rollup adding that, you know,</span> <span data-start="1774.43" data-end="1776.81">exposing their built-in resolution is maybe there is an</span> <span data-start="1776.81" data-end="1778.94">option you could pass that's like, "Oh by the way, like</span> <span data-start="1779.02" data-end="1780.94">resolve it all against this public path".</span> <span data-start="1782.19" data-end="1783.52">That might be a convenient thing.</span> <span data-start="1783.65" data-end="1784.44">Who knows.</span> <span data-start="1784.44" data-end="1787.28">So while we remap all of those file names to prepend</span> <span data-start="1787.49" data-end="1789.45">that public path, we can also remove any</span> <span data-start="1790.57" data-end="1793.12">trailing index.HTML, because that doesn't appear in URLs.</span> <span data-start="1793.91" data-end="1795.87">We want to cache the URLs not the file names.</span> <span data-start="1796.12" data-end="1799">And we will use that dot workaround to safeguard</span> <span data-start="1799.08" data-end="1802.29">against an empty string actually caching the service</span> <span data-start="1802.29" data-end="1804.59">worker, which we don't want, instead, we'll have it catch</span> <span data-start="1804.67" data-end="1806.09">the directory the service worker is in.</span> </p>
<p><span data-start="1807.72" data-end="1810.34">So that's both of our magic globals prepared for the</span> <span data-start="1810.34" data-end="1812.6">service worker. Now it's time to generate it.</span> <span data-start="1813.93" data-end="1816.27">And here we're going to create one last function to handle</span> <span data-start="1816.31" data-end="1817.56">compilation of the service worker.</span> <span data-start="1818.18" data-end="1820.73">So to build our service worker module, we're going to use</span> <span data-start="1820.73" data-end="1822.94">something called a child compiler, which is essentially a</span> <span data-start="1822.94" data-end="1824.82">nested webpack compiler.</span> </p>
<p><span data-start="1825.65" data-end="1827.32">And we'll configure this to output this</span> <span data-start="1828.99" data-end="1829.99">sw.js file.</span> <span data-start="1830.61" data-end="1833.78">And one thing to think about when using child compilers</span> <span data-start="1833.78" data-end="1836.91">is they can have a completely different list of plugins</span> <span data-start="1836.99" data-end="1838.37">compared to the main compiler.</span> <span data-start="1838.87" data-end="1841.54">So we can pull in a plugin that generates worker</span> <span data-start="1841.96" data-end="1845.04">compatible code because we have a service worker target.</span> <span data-start="1845.67" data-end="1847.59">So this could be a difference as well, isn't it?</span> <span data-start="1847.63" data-end="1849.88">Because, like â€” Well, actually, you tell me.</span> <span data-start="1850.09" data-end="1853.01">Because you're using a child compiler and</span> <span data-start="1853.09" data-end="1854.3">it's like a whole different pass.</span> <span data-start="1855.22" data-end="1858.1">Does that mean that this service worker bundle is not going</span> <span data-start="1858.31" data-end="1860.06">to be able to share code with the main bundle.</span> </p>
<p><span data-start="1860.06" data-end="1861.39">It's not going to be up to code split there.</span> <span data-start="1861.52" data-end="1864.27">Correct. Yeah. So any split points that end up happening</span> <span data-start="1864.52" data-end="1867.15">in the code generated by this child compiler are going</span> <span data-start="1867.57" data-end="1870.15">to be totally independent from the main compiler.</span> <span data-start="1870.19" data-end="1871.7">They'll be a separate set of files.</span> <span data-start="1873.28" data-end="1874.66">That's an important difference between the two.</span> <span data-start="1874.74" data-end="1877.45">I mean, it's not common to share code between your service</span> <span data-start="1877.45" data-end="1879.95">worker and main thread, but the Rollup version could</span> <span data-start="1880.41" data-end="1881">do that.</span> </p>
<p><span data-start="1881" data-end="1882">Yeah, exactly.</span> <span data-start="1883.21" data-end="1885.79">So the other thing that worker template will do in this</span> <span data-start="1885.79" data-end="1888.09">case is, if there are split points, rather than</span> <span data-start="1888.75" data-end="1890.67">using a script tag to load those chunks</span> <span data-start="1891.92" data-end="1894.64">of code, it will use import scripts, which is available in</span> <span data-start="1894.64" data-end="1895.18">workers.</span> <span data-start="1895.18" data-end="1896.18">Cool.</span> <span data-start="1896.8" data-end="1898.76">And so the last thing we need is a second plugin.</span> <span data-start="1899.14" data-end="1900.72">Also imported from webpack core.</span> </p>
<p><span data-start="1901.23" data-end="1903.73">And this just lets us specify the entry module</span> <span data-start="1904.56" data-end="1905.81">to start compiling from.</span> <span data-start="1906.11" data-end="1908.19">Which is, in this case, our service worker source module.</span> <span data-start="1909.69" data-end="1912.74">So finally we run our compiler as a child</span> <span data-start="1912.78" data-end="1913.9">of the main compiler.</span> <span data-start="1914.32" data-end="1917.32">And this just ensures that if our compiler takes a while to</span> <span data-start="1917.32" data-end="1920.12">run, the main compiler won't finish and terminate the</span> <span data-start="1920.12" data-end="1921.5">process before we're finished.</span> </p>
<p><span data-start="1923.04" data-end="1926">And then once it's built, the callback will be called with</span> <span data-start="1926.42" data-end="1927.59">our compilation.</span> <span data-start="1928.54" data-end="1929.96">And also any error.</span> <span data-start="1931.01" data-end="1933.67">So just like with the emit hook, we are going to grab the</span> <span data-start="1933.67" data-end="1936.05">generated service worker asset from compilation.assets</span> <span data-start="1937.3" data-end="1938.68">and then we can pass that back to emit.</span> <span data-start="1940.97" data-end="1943.52">If there was an error in the child compiler say, you know,</span> <span data-start="1943.77" data-end="1946.1">a syntax error in our service worker code, we'll just</span> <span data-start="1946.1" data-end="1948.11">bubble that up. That will fail the build and print it to</span> <span data-start="1948.11" data-end="1949.11">console.</span> </p>
<p><span data-start="1949.69" data-end="1952.28">If there wasn't an error, we do now have our compiled</span> <span data-start="1952.28" data-end="1953.32">service worker asset.</span> <span data-start="1954.03" data-end="1957.2">The thing is, it doesn't yet have version and assets</span> <span data-start="1957.7" data-end="1959.12">magic global variables.</span> <span data-start="1960.03" data-end="1962.58">So to inject those, we need to pull in something called</span> <span data-start="1962.58" data-end="1965.08">ConcatSource from the webpack-sources module.</span> <span data-start="1965.92" data-end="1968.83">And this lets us concatenate strings essentially.</span> <span data-start="1968.92" data-end="1971.92">It's very similar to string concat, but with the</span> <span data-start="1972" data-end="1975.22">added benefit of, it is able to produce</span> <span data-start="1975.3" data-end="1976.26">source maps.</span> <span data-start="1976.93" data-end="1978.14">Ah yes.</span> <span data-start="1978.22" data-end="1981.26">OK, so this is interesting because I broke source maps in</span> <span data-start="1981.26" data-end="1982.26">my solution.</span> <span data-start="1982.93" data-end="1985.1">But this, this is going to just, just work.</span> <span data-start="1985.39" data-end="1988.02">Now I could have done the same. In Rollup I could have</span> <span data-start="1988.1" data-end="1989.65">created essentially â€” It doesn't</span> <span data-start="1991.4" data-end="1994.07">support child compilers and such, but you can just call</span> </p>
<p><span data-start="1994.53" data-end="1997.2">Rollup as a sort of separate layer.</span> <span data-start="1997.95" data-end="1999.32">That would've been a lot more complicated.</span> <span data-start="1999.32" data-end="2001.83">So it's interesting now, like some of the complexity that</span> <span data-start="2001.83" data-end="2004.16">you're using here with webpack is actually</span> <span data-start="2004.91" data-end="2005.62">paying off.</span> </p>
<p><span data-start="2005.62" data-end="2008.79">Right. Yeah. So like the initial bundle of service worker</span> <span data-start="2008.83" data-end="2011.42">was harder. But as it turns out, it's the same number of</span> <span data-start="2011.42" data-end="2014.51">lines to support source maps as it is to not support</span> <span data-start="2014.51" data-end="2016.88">source maps. Now that you've opted into some of that</span> <span data-start="2016.88" data-end="2019.76">complexity. So that's sort of an interesting tradeoff</span> <span data-start="2019.76" data-end="2020.97">between the two.</span> <span data-start="2021.26" data-end="2024.06">So, yeah. So the last step, we've constructed this asset,</span> <span data-start="2024.31" data-end="2026.23">but it's only just an object in memory.</span> <span data-start="2026.81" data-end="2029.94">So what we need to do is merge it into</span> <span data-start="2029.94" data-end="2031.86">the compiler's generated assets.</span> <span data-start="2031.98" data-end="2034.78">Like with Rollup, this is a live object and anything that</span> <span data-start="2035.03" data-end="2036.74">we merge into here will get written to disk.</span> <span data-start="2037.32" data-end="2039.28">And so with that, our plugin is done.</span> <span data-start="2039.45" data-end="2041.91">So we can call the callback compilation will finish.</span> <span data-start="2042.41" data-end="2043.99">And what we get is our generated</span> <span data-start="2045.54" data-end="2046.54">service worker source.</span> </p>
<p><span data-start="2047" data-end="2050.17">We can see here that we have assets with</span> <span data-start="2050.17" data-end="2051.54">the generated array of URLs.</span> <span data-start="2053.21" data-end="2056.21">And we also have version which is that</span> <span data-start="2056.21" data-end="2058.42">string based on the hash of their contents.</span> <span data-start="2058.63" data-end="2059.63">So we did it.</span> <span data-start="2060.09" data-end="2061.3">Amazing. And that's it.</span> <span data-start="2062.8" data-end="2065.1">Yeah. And I guess that's that's bringing this talk to a</span> <span data-start="2065.1" data-end="2068.14">close. Provided that everything is recorded</span> <span data-start="2068.18" data-end="2070.94">properly and we don't have to do it again because I can't</span> <span data-start="2070.98" data-end="2072.86">tell you this recording has been absolutely cursed.</span> <span data-start="2073.19" data-end="2075.98">We have done so many takes due to just Bluetooth stacks</span> <span data-start="2076.28" data-end="2079.15">failing on my machine, recordings not happening on Jason's</span> <span data-start="2079.53" data-end="2081.16">machine. So who knows?</span> <span data-start="2081.41" data-end="2082.66">Maybe this will be the final record.</span> <span data-start="2082.7" data-end="2085.49">If you're watching this right now, then I am so happy</span> <span data-start="2085.53" data-end="2088.79">because it means we don't have to do all of this again.</span> </p>
<p><span data-start="2090" data-end="2091.37">Oh, right, OK.</span> <span data-start="2091.46" data-end="2093.75">If you want to see those implementations, they are both on</span> <span data-start="2094" data-end="2096.67">Tooling.Report along with how to handle assets, code</span> <span data-start="2096.67" data-end="2099.84">splitting, hashing, transformations, all of that stuff.</span> </p>
<p><span data-start="2099.97" data-end="2102.84">And not just webpack and Rollup as well.</span> <span data-start="2102.84" data-end="2106.06">We also have Parcel, and we also have</span> <span data-start="2106.35" data-end="2107.68">Browserify. Remember, Browserify?</span> <span data-start="2108.14" data-end="2109.77">And Gulp! And all of that sort of stuff.</span> <span data-start="2110.14" data-end="2113.31">I mean, you might laugh at that, but this</span> <span data-start="2113.31" data-end="2115.77">is if you look at the stats on NPM, that is still</span> <span data-start="2116.11" data-end="2117.94">absolutely huge and climbing.</span> <span data-start="2117.94" data-end="2120.69">So we did actually find some cases where it really holds</span> <span data-start="2120.94" data-end="2123.78">its own and was maybe better than some of the</span> <span data-start="2124.03" data-end="2127.16">more modern things that we deal with.</span> <span data-start="2127.58" data-end="2129.16">So go on and check all of that out.</span> <span data-start="2129.5" data-end="2131.16">Thanks so much for watching this.</span> <span data-start="2131.46" data-end="2133.62">Hopefully final take of this talk.</span> </p>
</section>

<!-- div#container ends -->
</div>

<img alt="The End" id="fin" src="../images/fin.jpg">

<script>
/*eslint-disable */
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google-translate');
}
/* eslint-enable */
</script>

<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script src="../js/main.js"></script>

</body>

</html>
